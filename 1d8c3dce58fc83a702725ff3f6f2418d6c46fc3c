{
  "comments": [
    {
      "key": {
        "uuid": "98439f60_3995db55",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-09T10:00:21Z",
      "side": 1,
      "message": "I like the proposed solution... but I guess that it is quite hard to read for those\nnow knowing the internals of the replication plugin (which may be the case even for\nmany Gerrit core contributors). Adding some examples for how an ref-updated event\nis translated into replication tasks and how the tasks are distributed among master nodes\nwould greatly help to better follow and understand this document.",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "55fe8ebb_fb7c8d0e",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-10T18:30:20Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "98439f60_3995db55",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8a98db26_3d97667c",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 2,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-10-09T10:11:18Z",
      "side": 1,
      "message": "I would also like to have a scaling multi master replication in share nothing strategie installations, also without shared FS.",
      "range": {
        "startLine": 2,
        "startChar": 48,
        "endLine": 2,
        "endChar": 71
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b45cf87f_7a882bd3",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 2,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-09T16:24:01Z",
      "side": 1,
      "message": "It\u0027s not obvious to me how it would be useful to share replication if you don\u0027t share the git repos/refs, what would you use that for?",
      "parentUuid": "8a98db26_3d97667c",
      "range": {
        "startLine": 2,
        "startChar": 48,
        "endLine": 2,
        "endChar": 71
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "327b16f1_a572177b",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 2,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-10-09T21:49:18Z",
      "side": 1,
      "message": "What about a message broker?",
      "parentUuid": "b45cf87f_7a882bd3",
      "range": {
        "startLine": 2,
        "startChar": 48,
        "endLine": 2,
        "endChar": 71
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4b6fa521_26742f7f",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 2,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-09T22:11:26Z",
      "side": 1,
      "message": "\"Shared nothing\" is not part of the use case.",
      "parentUuid": "327b16f1_a572177b",
      "range": {
        "startLine": 2,
        "startChar": 48,
        "endLine": 2,
        "endChar": 71
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c7ced38f_43af824a",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 2,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-10T18:30:20Z",
      "side": 1,
      "message": "Fixed use case to be clearer.",
      "parentUuid": "4b6fa521_26742f7f",
      "range": {
        "startLine": 2,
        "startChar": 48,
        "endLine": 2,
        "endChar": 71
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "73d43ecf_b55c8b1a",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-09T10:00:21Z",
      "side": 1,
      "message": "This document assumes that we add more master nodes in order to run more instances of the replication plugin. This is OK and probably the only possibility with what we have today.\n\nAs we have been experimenting with running and managing Gerrit nodes in k8s for quite some time\nI would also like to propose thinking about having specialized \"replicator\" nodes whose only\npurpose would be to perform replication tasks. In this scenario, we would scale the replication\nby adding more replicator nodes and I believe that this gives us more flexibility i.e. we\ndo not necessary need to add a full master node in order to scale-up the replication. Replication plugin would still need to run in each master-node but its only purpose would\nbe to process the ref-updated events and persist the replication tasks in the \"waiting\" directory. On the \"replicator\" nodes we would run the replication plugin as a\nstandalone application. If this makes sense to you we should discuss this in a separate\ndesign doc?",
      "range": {
        "startLine": 30,
        "startChar": 24,
        "endLine": 30,
        "endChar": 37
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "878c6d40_6a1fd990",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-10-09T10:05:50Z",
      "side": 1,
      "message": "\u003e This document assumes that we add more master nodes in order to run more instances of the replication plugin. This is OK and probably the only possibility with what we have today.\n\u003e \n\u003e As we have been experimenting with running and managing Gerrit nodes in k8s for quite some time\n\u003e I would also like to propose thinking about having specialized \"replicator\" nodes whose only\n\u003e purpose would be to perform replication tasks.\n\nI like a lot this proposal: the specialised \"replicator\" node could also use more \"boosted\" version of JGit (e.g. powered by Git Protocol v2) and have a dedicated scalable and elastic deployment.\n\nWe do need, however, to replace the in-memory replication queue with an external message broker.\n\n\u003e In this scenario, we would scale the replication\n\u003e by adding more replicator nodes and I believe that this gives us more flexibility i.e. we\n\u003e do not necessary need to add a full master node in order to scale-up the replication. \n\n+1 to that.",
      "parentUuid": "73d43ecf_b55c8b1a",
      "range": {
        "startLine": 30,
        "startChar": 24,
        "endLine": 30,
        "endChar": 37
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "53b6c37f_b452deee",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1011323
      },
      "writtenOn": "2019-10-09T10:11:18Z",
      "side": 1,
      "message": "+1 for replicator node, with standalone replication plugin. This should probably go in its own design doc, though.",
      "parentUuid": "878c6d40_6a1fd990",
      "range": {
        "startLine": 30,
        "startChar": 24,
        "endLine": 30,
        "endChar": 37
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ebbfc28c_fda2bafc",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-09T16:24:01Z",
      "side": 1,
      "message": "\u003e This document assumes that we add more master nodes in order to run more instances of the replication plugin. This is OK and probably the only possibility with what we have today.\n\nIt is not an assumption of this document, it is part of the use case definition of the parent doc.\n\n\u003e On the \"replicator\" nodes we would run the replication plugin as a standalone application. If this makes sense to you we should discuss this in a separate design doc?\n\nYes, this would be neat, and yes I would suggest a very different design doc for that.\n\nAs a suggested starting direction for your replicator nodes, it probably makes sense to start with full gerrit master nodes along with this solution as you replicator nodes. If you want to make those node much leaner, i.e. closer to running the replication plugin as a standalone app, but without loosing any functionality currently supported by the plugin you would probably need to have a, potentially minimal, application framework. This framework would need APIs that look like Gerrit\u0027s that provide at least the following features: gerrit based read ACL permission interpretations (including perm logic for changes, tags, and other special Gerrit refs), threadpool support, and ssh command support for the show-queue and replication commands.\n\nYou might then decide to leverage the existing Gerrit code base to create such a minimal framework, perhaps by defining some minimal framework that the replication plugin could be run with. The next question then becomes, what else could leverage that framework? In the kubernetes world, such a framework might become a useful way to isolate and scale independent tasks like replication, gitles, git serving...\n\nOf course, the natural progression is to give such a framework a fancy name (aclgit, ggit, geegit, gergit?) and to  eventually build Gerrit itself on it? I am feeling like maybe this has been suggested before? :) I would support anyone seeking this path.",
      "parentUuid": "53b6c37f_b452deee",
      "range": {
        "startLine": 30,
        "startChar": 24,
        "endLine": 30,
        "endChar": 37
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "43faa7e2_8dd3164e",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1006192
      },
      "writtenOn": "2019-10-09T21:49:18Z",
      "side": 1,
      "message": "My view would be that the \"replicator\" could be a \"startup mode\" of Gerrit without a GUI and without accepting incoming Git protocol requests.",
      "parentUuid": "ebbfc28c_fda2bafc",
      "range": {
        "startLine": 30,
        "startChar": 24,
        "endLine": 30,
        "endChar": 37
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "28c89521_98565ddb",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-10T12:16:37Z",
      "side": 1,
      "message": "\u003e As a suggested starting direction for your replicator nodes, it probably makes sense to start \n\u003e with full gerrit master nodes along with this solution as you replicator nodes. If you want to \n\u003e make those node much leaner, i.e. closer to running the replication plugin as a standalone\n\u003e app, but without loosing any functionality currently supported by the plugin you would\n\u003e probably need to have a, potentially minimal, application framework.\n\nMy proposal here is strictly limited to running the replication as a standalone application.\nRunning *any* plugin standalone is out of scope.\n\n\u003e APIs that look like Gerrit\u0027s that provide at least the following features: gerrit based read \n\u003e ACL permission interpretations (including perm logic for changes, tags, and other special \n\nSpecifically for the replication I believe that we do not need all of that because\nthere would be a stripped down replication plugin running inside the Gerrit master\nnodes, whose purpose is to:\n* listen to ref-updated events\n* evaluate all the necessary permissions\n* create replication tasks\n\nOnce replication tasks are created (in the shared fils system) they just have to be done, period.\nNo permission evaluation is necessary after the tasks are created.\nTheoretically, the replication tasks could even be processed just by using bash and native\nGit (not that I am suggesting that) assuming the scripts follow all the contracts for FS based locking.\n\n\u003e threadpool support, and ssh command support for the show-queue and replication commands.\n\nYes, this part is needed but this is already nothing Gerrit specific.\n\n\u003e Of course, the natural progression is to give such a framework a fancy name (aclgit, ggit,\n\u003e geegit, gergit?) and to  eventually build Gerrit itself on it? I am feeling like maybe this\n\u003e has been suggested before? :) I would support anyone seeking this path\n\nThis is a valid goal but, as said, I believe that we do not need that for the replicator nodes.",
      "parentUuid": "43faa7e2_8dd3164e",
      "range": {
        "startLine": 30,
        "startChar": 24,
        "endLine": 30,
        "endChar": 37
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5cb992b8_56db196d",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 30,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-10T18:30:20Z",
      "side": 1,
      "message": "\u003e Once replication tasks are created (in the shared fils system) they just have to be done, period. No permission evaluation is necessary after the tasks are created.\n\nI\u0027m not sure this is possible for \"replicate all\" scenarios?",
      "parentUuid": "28c89521_98565ddb",
      "range": {
        "startLine": 30,
        "startChar": 24,
        "endLine": 30,
        "endChar": 37
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2e4e386b_1ff77ab4",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 47,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-09T10:00:21Z",
      "side": 1,
      "message": "threads",
      "range": {
        "startLine": 47,
        "startChar": 19,
        "endLine": 47,
        "endChar": 25
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "839d99c2_a098c1aa",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 47,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-10T18:30:20Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "2e4e386b_1ff77ab4",
      "range": {
        "startLine": 47,
        "startChar": 19,
        "endLine": 47,
        "endChar": 25
      },
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "10e3ca37_b98273fc",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 270,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-09T10:00:21Z",
      "side": 1,
      "message": "This is already described above (line 45)",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f68bc302_a02c0cc7",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 270,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-10T18:30:20Z",
      "side": 1,
      "message": "I revamped this section a bit to be more action specific focused on actual plugin changes and to try to reduce the duplication from the design section. Hopefully it is better now.",
      "parentUuid": "10e3ca37_b98273fc",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "468804bc_5ff6dde3",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 283,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-09T10:00:21Z",
      "side": 1,
      "message": "This is already described above",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e0d06ebe_f6d5a2b2",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 283,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-10T18:30:20Z",
      "side": 1,
      "message": "same as above",
      "parentUuid": "468804bc_5ff6dde3",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6358c002_c00cba80",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 290,
      "author": {
        "id": 1003873
      },
      "writtenOn": "2019-10-09T10:00:21Z",
      "side": 1,
      "message": "This is already described above",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d64a3de1_2c5526db",
        "filename": "pages/design-docs/scaling-multi-master-replication/solution-distribute-replication-tasks-via-shared-FS.md",
        "patchSetId": 1
      },
      "lineNbr": 290,
      "author": {
        "id": 1003883
      },
      "writtenOn": "2019-10-10T18:30:20Z",
      "side": 1,
      "message": "same as above",
      "parentUuid": "6358c002_c00cba80",
      "revId": "1d8c3dce58fc83a702725ff3f6f2418d6c46fc3c",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153",
      "unresolved": false
    }
  ]
}